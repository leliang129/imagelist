# imagelist

## 读取 K8s 资源镜像列举器

## 任务进度
- [x] 需求 / PRD 撰写（当前）
- [ ] 技术方案与估算
- [ ] 功能开发
- [ ] 测试验证
- [ ] 用户验收

## 需求总览
- **需求编号**: R-2024-001
- **需求描述**: 读取 Kubernetes 资源定义文件中引用的容器镜像，并汇总输出镜像清单，帮助团队快速掌握集群所需镜像及其版本。
- **业务价值**: 降低运维排查镜像版本、镜像安全扫描与合规检查的成本，提高发布前的镜像确认效率。
- **适用范围**: 支持 K8s YAML / JSON 资源文件（Deployment、StatefulSet、DaemonSet、Job、CronJob、Pod 等）。
- **不在范围**: 不处理 Helm Chart 渲染、实时连接集群 API、镜像安全扫描或漏洞评分。

## 功能 PRD

### 背景与目标
在多环境的 K8s 集群中，镜像来源和版本分散，手动梳理成本高且易遗漏。本工具希望通过解析资源文件，自动提取镜像列表，为运维与研发人员提供透明的镜像视图，进一步支持合规与发布准备流程。

### 用户角色与痛点
- **运维工程师**: 需要快速确认即将部署或已部署资源所引用的镜像，以便进行安全检查与版本对比。
- **研发工程师**: 希望在提交变更前确认镜像标记是否正确，避免上线事故。
- **安全合规人员**: 需要定期导出镜像清单，与漏洞数据库进行对照。

### 用户故事
1. 作为运维工程师，我想把指定目录下的 K8s YAML 上传给工具，让它列出所有镜像，方便我做安全扫描。
2. 作为研发，我想让工具标注重复镜像和最新使用次数，以便确认是否存在旧镜像引用。
3. 作为安全人员，我希望工具能导出 CSV，便于后续与第三方系统对接。

### 功能需求
- **多文件输入**: 支持传入文件或目录，递归解析 `.yaml`、`.yml`、`.json`。
- **资源类型识别**: 自动识别常见工作负载资源，定位 `containers` 与 `initContainers` 下的 `image` 字段。
- **镜像去重**: 组合 `registry / repository / tag` 作为唯一键，输出去重结果，并附带被引用的资源名称与所属文件路径。
- **输出展示**: 终端输出表格视图，并可选导出 `JSON` 与 `CSV` 格式。
- **统计信息**: 汇总镜像总数、唯一镜像数、缺失 tag 的镜像数量等指标。
- **错误反馈**: 对无法解析的文件给出提示，不影响其他文件读取。
- **交互扩展**: 除文件上传外，提供文本输入框，支持直接粘贴 YAML / JSON 内容并完成解析。

### 非功能需求
- **易用性**: 提供简洁命令行参数，支持本地快速运行。
- **性能要求**: 在 500 个资源文件以内解析时间不超过 5 秒。
- **兼容性**: 运行于 macOS / Linux，支持 Python 3.9+ 环境。

### 数据与接口
- **输入**: 本地路径参数，指向单个文件或目录。
- **处理流程**:
  1. 读取并解析 YAML / JSON。
  2. 遍历容器字段提取镜像，记录来源上下文。
  3. 聚合并统计镜像信息。
  4. 根据参数输出终端表格或导出文件。
- **输出**:
  - 终端展示：资源名称、命名空间、镜像、文件路径。
  - 导出文件：JSON / CSV（可选）。

### 成功度量与验收标准
- 提供 CLI 帮助说明，包含核心参数示例。
- 能在示例资源目录上正确解析所有镜像，输出数量与人工核对一致。
- 对至少三种不同资源类型（Deployment / StatefulSet / CronJob）提供正确结果。
- 导出 CSV 文件包含预期列，且可被常见表格工具无误打开。

### 风险与假设
- **风险**: 部分自定义资源（CRD）可能使用非标准容器字段，需后续扩展。
- **风险**: 特殊 YAML 模板语法（如 `{{ }}`）导致解析失败，需要预处理或提示用户。
- **假设**: 用户可提供已渲染的资源文件；镜像字段遵守 K8s 标准结构。

### 排期建议
- **第 1 天**: 细化技术设计、确定解析库与输出格式。
- **第 2-3 天**: 实现文件解析、镜像提取与终端输出。
- **第 4 天**: 完成导出功能、增加示例与文档。
- **第 5 天**: 编写测试、联调与交付验收。

## 纯前端方案草案（2025-10-16）
- **目标**: 使用纯前端技术（HTML/JS/TS + Web 前端工具链）在浏览器内完成 YAML/JSON 解析、镜像提取与结果展示，用户无需本地安装依赖。
- **主要能力**:
  - 支持拖拽或选择本地文件，解析后在页面展示镜像列表与统计信息。
  - 允许导出 JSON / CSV（可通过浏览器生成下载）。
  - 提供镜像搜索、筛选与缺失标签提示。
- **技术选型初步设想**:
  - 解析：`js-yaml` 或 `yaml` npm 包；如需 JSONPath 可考虑 `jsonpath-plus`。
  - 框架：倾向使用 React + TypeScript；若需更轻量可考虑 Preact。
  - 构建：Vite 提供本地调试与打包；部署可直接使用静态托管（GitHub Pages、OSS）。
- **关键模块规划**:
  - `App`: 负责页面布局与状态管理（选中文件、解析结果、统计信息）。
  - `ManualInputPanel`: 承载文本输入、文件选择与拖拽上传入口，采用双列工作台布局。
  - `ImageTable`: 展示镜像明细，支持筛选与复制。
  - `services/parser.ts`: 封装文件读取与 YAML/JSON 解析逻辑。
- **与现有 CLI 的关系**:
  - CLI 原型保留，未来可作为高级功能或离线工具。
  - 当前迭代聚焦前端 MVP，如需精简后端代码，可在评审后决定是否迁移至独立仓库。
- **开放问题**:
  - 浏览器解析大型目录性能如何，需要基准测试。
  - 是否支持压缩包上传，以减少多文件选择步骤。
  - 安全沙箱：浏览器端处理本地文件，无需上传；需明确隐私说明。

## 前端架构指南
- **目录结构**: 所有实现代码位于 `frontend/`，使用 Vite + React + TypeScript。
- **状态管理**: 采用 React Hooks 管理解析结果与统计数据，后续如需跨组件状态可引入 Zustand / Redux。
- **文件解析流程**:
  1. `ManualInputPanel` 支持文本粘贴、文件选择与拖拽读取。
  2. `services/parser.ts` 使用 `js-yaml` 解析文档，提取镜像引用信息。
  3. `App` 将结果传递给 `ImageTable` 展示。
  4. `services/save.ts` 支持一键导出 JSON / CSV 报表。
- **样式系统**: 暂采用全局 CSS，后续可评估引入 Tailwind / CSS Modules。

## 需求与设计变更记录
- 2025-10-16: 初始化项目，确认镜像列举需求，输出 PRD。
- 2025-10-16: 与产品确认先行搭建 CLI 框架骨架的需求，输出设计草案。
- 2025-10-16: 创建 `k8s_image_tool` 包结构与 CLI 占位实现，支持初步预览。
- 2025-10-16: 新增纯前端实现需求，完成浏览器端方案草案。
- 2025-10-16: 搭建 `frontend/` 目录，完成 React + Vite 骨架与核心组件占位，实现文件拖拽、解析与导出框架。
- 2025-10-16: 确认项目聚焦纯前端实现，移除 Python CLI 相关目录与文件。
- 2025-10-16: 新增前端文本输入解析组件与流程，支持直接粘贴内容解析镜像。
- 2025-10-16: 优化前端布局为左右分栏，输入区与结果区分列展示。
- 2025-10-16: 为镜像列表添加一键复制名称功能，提升导出效率。
- 2025-10-16: 调整页面布局支持全宽自适应，提升宽屏体验。
- 2025-10-16: 优化镜像复制提示为单条高亮，避免重复条目同时提示。
- 2025-10-16: 引入双列工作台界面样式，对齐参考设计的平铺布局体验。
- 2025-10-16: 美化输入/输出工作台，整合格式选择与操作区，统一结果表格样式。
- 2025-10-16: 新增站点 Logo 与浏览器标签图标，优化视觉识别。

## 后续工作待办
- [x] 形成纯前端方案草案。
- [x] 搭建前端项目脚手架与基础组件。
- [x] 支持前端文本输入解析通道。
- [x] 镜像列表支持一键复制镜像名称。
- [x] 页面布局支持全宽自适应展示。
- [x] 优化镜像复制提示状态管理。
- [x] 根据参考设计精修输入输出工作台细节。
- [ ] 评审纯前端技术选型与信息架构。
- [ ] 设计前端界面交互原型。
- [ ] 准备前端解析与展示用示例数据。
- [ ] 完成浏览器端镜像解析与导出实现细节。
- [ ] 编写前端单元与端到端测试。
- [ ] 完善 Web 使用文档并准备演示样例。

## 前端开发提示
- 推荐使用 `pnpm install --registry=https://registry.npmmirror.com` 或配置 `npm` 国内源后安装依赖。
- 本地开发：进入 `frontend/` 后执行 `pnpm dev` 或 `npm run dev`，默认端口 `5173`。
- 构建预览：`pnpm build && pnpm preview`，产物输出至 `frontend/dist/`。
